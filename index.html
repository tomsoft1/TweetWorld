<html>
<title>TweetOMap</title>
<script src="/socket.io/socket.io.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="processing.js"></script>

<style>
body{margin:0px;width: 100%; font-family: "Helvetica Neue";background-color: #000}
#canvas-ps { width: 100%; }
.test {color:#FFF;}
.screen{position: absolute;top:0;left:0;height:100%;width: 100%}
#buttons { position: absolute; top:140;width:180px;background-color: 0xF00;}
#about { position: absolute; top:80%;width:250px}
#map-overlay {position: absolute;left:0%;top: 0%; width:100%;height: 100%;color:#ccc;}
</style>
<body>
<script type="text/javascript">
window.twttr=(function(d,s,id){var t,js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)){return}js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);return window.twttr||(t={_e:[],ready:function(f){t._e.push(f)}})}(document,"script","twitter-wjs"));
</script>
<div class="screen" >
<canvas id="canvas-ps"></canvas>
<svg class="screen" id="g" viewBox="0 0 360 180">
   <circle  id="circle" cx="0" cy="0" r="1" stroke="grey" stroke-width="1" fill="blue" />
</svg>
<div id="map-overlay">
  <br>
 .<a class="twitter-share-button"
  href="https://twitter.com/share">
Tweet
</a>

<div id="about">
  <H4>TweetMap</H4>
  Display in real time geolocalized tweets, in red those send through iPhone, in blue From android, and white others...
</div>
</div>

<div id="buttons">
  <H3 id="newTweet" class='test'><H3>
</div>




<script>
$.urlParam = function(name){
  try{
    var results = new RegExp('[\?&amp;]' + name + '=([^&amp;#]*)').exec(window.location.href);
    return results[1] || 0;
  }catch(e){}
}
 var size=1024/360;

 function sketchProc(processing) {
  var bg;
  processing.setup=function(){
    processing.size(1024,512);
    processing.stroke(255,255,255,80);
    bg=processing.loadImage("world_map.png");

  }
    // Override draw function, by default it will be called 60 times per second
    processing.draw = function() {

      if(bg&&bg.height!=0){
        console.log("draw");
        processing.background(bg);
        processing.noLoop();
      }

    };
    }

 var canvas = document.getElementById("canvas-ps");
 // attaching the sketchProc function to the canvas
 var processingInstance = new Processing(canvas, sketchProc);

var hover_bubble=[];
var showTweets=true;
var socket=null;
window.onload = function() {
  startSocket();
};
var total=iphone=others=android=0;
function addPoint(tweet)
{
  if(tweet.geo){
//    console.log(tweet);
    var coords=tweet.geo.coordinates;
    if(/iphone/i.test(tweet.source)){
      processingInstance.stroke(255,0,0,80);
      iphone+=1;
    }else if(/android/i.test(tweet.source)){
      processingInstance.stroke(0,0,255,80);
      android+=1;
    }else{
      processingInstance.stroke(255,255,255,80);
      others+=1;
    }
    var x=size*(180+coords[1]);
    var y=size*(90-coords[0]);
    processingInstance.point(x,y);
    $("#g").height($("#canvas-ps").height());
    $("circle").attr("cx",180+coords[1]).attr("cy",90-coords[0]);
    total+=1;
    $("#newTweet").text("Total: "+total+"  iphone:"+iphone+"  android:"+android+" others:"+others);
  }
}

function toggleTweets()
{
  showTweets=!showTweets;
  console.log(showTweets);
}

function updateSocket(){
//  window.history.pushState("TweetOMap","TweetOMap","/?bounds=["+map.getBounds().toBBoxString()+"]");
  if(socket)socket.emit("recenter","-180,-90,180,90");
}
function startSocket(){
  socket = io.connect('/');
  socket.on('stream', function(tweet){
    addPoint(tweet);

  });
  socket.on('reconnect',function(){
    console.log("Reconnect");
    updateSocket();
  });
}

</script>
</body>
</html>